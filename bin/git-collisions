#!/usr/bin/env bash

set -euo pipefail

usage() {
  cat <<EOF
usage: git collisions [<options>] [--] [<rev-list args>]

Print commit hash collisions.

If no <rev-list args> are specified, default to "--all".

Options:
    -d, --digits
        Number of leading digits; default: core.abbrev or 7.

    -h, --help
        Show this help message and exit.
EOF
}

digits=

while (( $# )); do
  case "$1" in
    -d|--digits)
      shift
      digits="$1"
      ;;
    -h|--help)
      usage
      exit
      ;;
    --)
      shift
      break
      ;;
    -*)
      printf "error: invalid option: %s\n" "$1" >&2
      exit 1
      ;;
    *)
      break
      ;;
  esac
  shift
done

[[ -n "$digits" ]] || digits="$(git config core.abbrev)" || digits="7"
rev_list_args=("${@:---all}")

git rev-list "${rev_list_args[@]}" \
  | awk -v digits="$digits" '
    {
      abbrev = substr($0, 0, digits)
      hashes[abbrev][length(hashes[abbrev])] = $0
    }

    END {
      for (abbrev in hashes) {
        if (length(hashes[abbrev]) > 1) {
          for (i in hashes[abbrev]) {
            print hashes[abbrev][i]
          }
        }
      }
    }' \
  | sort \
  | uniq --check-chars="$digits" --group \
  | less -FRX
